name: CI/CD - build and deploy (tag-triggered)
on:
  push:
    # Trigger only when a tag starting with `v` is pushed (e.g. v1.2.3)
    tags: ["v*"]
permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: ${{ vars.IMAGE_NAME || format('ghcr.io/{0}', github.repository) }}
    steps:
      - uses: actions/checkout@v4

      - name: Resolve IMAGE_NAME
        run: |
          if [ -n "${{ vars.IMAGE_NAME }}" ]; then
            if [[ "${{ vars.IMAGE_NAME }}" == */* ]]; then
              echo "IMAGE_NAME=${{ vars.IMAGE_NAME }}" >> $GITHUB_ENV
            else
              echo "IMAGE_NAME=ghcr.io/${{ github.repository_owner }}/${{ vars.IMAGE_NAME }}" >> $GITHUB_ENV
            fi
          else
            echo "IMAGE_NAME=ghcr.io/${{ github.repository }}" >> $GITHUB_ENV
          fi

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR using GITHUB_TOKEN
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ github.ref_name }}-${{ github.run_number }}
            ${{ env.IMAGE_NAME }}:latest
          file: ./Dockerfile

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: ${{ vars.IMAGE_NAME || format('ghcr.io/{0}', github.repository) }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Wait for image available
        run: |
          echo "Image built: ${{ vars.IMAGE_NAME }}:${{ github.ref_name }}-${{ github.run_number }}"

      - name: Check deployment files exist
        run: |
          test -f docker-compose.yml
          test -f scripts/deploy.sh
          ls -lah docker-compose.yml scripts/deploy.sh

      - name: Copy docker-compose and deploy script to server
        uses: appleboy/scp-action@v0.1.6
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose.yml,scripts/deploy.sh"
          target: /${{ secrets.SSH_USER }}/works/api

      - name: SSH deploy - run deploy script (pull image & restart)
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            cd /${{ secrets.SSH_USER }}/works/api
            chmod +x ./deploy.sh
            # Call deploy script with IMAGE and TAG (tag includes build number)
            ./deploy.sh "${{ env.IMAGE_NAME }}" "${{ github.ref_name }}-${{ github.run_number }}" /${{ secrets.SSH_USER }}/works/api/docker-compose.yml
